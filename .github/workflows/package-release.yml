name: package-release

on:
  workflow_dispatch:
    inputs:
      version:
        description: Version string used in output filenames
        required: true
        type: string
  release:
    types:
      - published

permissions:
  contents: write

jobs:
  resolve-version:
    runs-on: ubuntu-latest
    outputs:
      version_raw: ${{ steps.version.outputs.version_raw }}
      version_safe: ${{ steps.version.outputs.version_safe }}
      console_bin: ${{ steps.version.outputs.console_bin }}
      worker_bin: ${{ steps.version.outputs.worker_bin }}
    steps:
      - name: Resolve version
        id: version
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            version_raw="${{ inputs.version }}"
          else
            version_raw="${{ github.event.release.tag_name }}"
          fi
          if [[ -z "${version_raw}" ]]; then
            echo "version is required" >&2
            exit 1
          fi

          version_safe="$(printf '%s' "${version_raw}" | sed -E 's/[^A-Za-z0-9._-]+/-/g')"
          if [[ -z "${version_safe}" ]]; then
            echo "sanitized version is empty" >&2
            exit 1
          fi

          console_bin="onlyboxes-console_${version_safe}_linux_amd64"
          worker_bin="onlyboxes-worker-docker_${version_safe}_linux_amd64"

          echo "version_raw=${version_raw}" >> "${GITHUB_OUTPUT}"
          echo "version_safe=${version_safe}" >> "${GITHUB_OUTPUT}"
          echo "console_bin=${console_bin}" >> "${GITHUB_OUTPUT}"
          echo "worker_bin=${worker_bin}" >> "${GITHUB_OUTPUT}"

  build-console:
    runs-on: ubuntu-latest
    needs: resolve-version
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'release' && github.event.release.tag_name || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Enable Corepack
        run: corepack enable

      - name: Build web
        shell: bash
        run: |
          set -euo pipefail
          yarn --cwd web install --immutable
          VITE_CONSOLE_VERSION="${{ needs.resolve-version.outputs.version_raw }}" yarn --cwd web build

      - name: Sync web dist into console embedded assets
        shell: bash
        run: |
          set -euo pipefail
          rm -rf console/internal/httpapi/web_dist
          mkdir -p console/internal/httpapi/web_dist
          cp -R web/dist/. console/internal/httpapi/web_dist/

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.x"
          cache-dependency-path: console/go.sum

      - name: Build console linux amd64 binary
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p build
          (
            cd console
            CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -trimpath \
              -ldflags "-X github.com/onlyboxes/onlyboxes/console/internal/buildinfo.Version=${{ needs.resolve-version.outputs.version_raw }}" \
              -o "../build/${{ needs.resolve-version.outputs.console_bin }}" \
              ./cmd/console
          )

      - name: Validate console ELF architecture
        shell: bash
        run: |
          set -euo pipefail
          console_info="$(file "build/${{ needs.resolve-version.outputs.console_bin }}")"
          echo "${console_info}"
          grep -Eq "ELF 64-bit.*x86-64" <<< "${console_info}"

      - name: Upload console workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: onlyboxes-console-linux-amd64-${{ needs.resolve-version.outputs.version_safe }}
          path: build/${{ needs.resolve-version.outputs.console_bin }}
          if-no-files-found: error

      - name: Upload console release asset
        if: github.event_name == 'release'
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          gh release upload "${{ needs.resolve-version.outputs.version_raw }}" \
            "build/${{ needs.resolve-version.outputs.console_bin }}" \
            --clobber

  build-worker:
    runs-on: ubuntu-latest
    needs: resolve-version
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'release' && github.event.release.tag_name || github.ref }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.x"
          cache-dependency-path: worker/worker-docker/go.sum

      - name: Build worker linux amd64 binary
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p build
          (
            cd worker/worker-docker
            CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -trimpath \
              -ldflags "-X github.com/onlyboxes/onlyboxes/worker/worker-docker/internal/buildinfo.Version=${{ needs.resolve-version.outputs.version_raw }}" \
              -o "../../build/${{ needs.resolve-version.outputs.worker_bin }}" \
              ./cmd/worker-docker
          )

      - name: Validate worker ELF architecture
        shell: bash
        run: |
          set -euo pipefail
          worker_info="$(file "build/${{ needs.resolve-version.outputs.worker_bin }}")"
          echo "${worker_info}"
          grep -Eq "ELF 64-bit.*x86-64" <<< "${worker_info}"

      - name: Upload worker workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: onlyboxes-worker-docker-linux-amd64-${{ needs.resolve-version.outputs.version_safe }}
          path: build/${{ needs.resolve-version.outputs.worker_bin }}
          if-no-files-found: error

      - name: Upload worker release asset
        if: github.event_name == 'release'
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          gh release upload "${{ needs.resolve-version.outputs.version_raw }}" \
            "build/${{ needs.resolve-version.outputs.worker_bin }}" \
            --clobber

  docker-console:
    runs-on: ubuntu-latest
    needs:
      - resolve-version
      - build-console
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'release' && github.event.release.tag_name || github.ref }}

      - name: Download console binary artifact
        uses: actions/download-artifact@v4
        with:
          name: onlyboxes-console-linux-amd64-${{ needs.resolve-version.outputs.version_safe }}
          path: build

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Resolve Docker tags
        id: docker_tags
        shell: bash
        env:
          VERSION_SAFE: ${{ needs.resolve-version.outputs.version_safe }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          set -euo pipefail
          image_repo="${DOCKERHUB_USERNAME}/onlyboxes"

          console_tags="${image_repo}:${VERSION_SAFE}"

          if [[ "${GITHUB_EVENT_NAME}" == "release" ]]; then
            console_tags+=$'\n'"${image_repo}:latest"
          fi

          {
            echo "console_tags<<EOF"
            echo "${console_tags}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      - name: Prepare Docker build context
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p build/docker/console
          cp "build/${{ needs.resolve-version.outputs.console_bin }}" "build/docker/console/onlyboxes-console"
          cp docker/console.dockerfile "build/docker/console/Dockerfile"

      - name: Build and push console image
        uses: docker/build-push-action@v6
        with:
          context: build/docker/console
          file: build/docker/console/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.docker_tags.outputs.console_tags }}
