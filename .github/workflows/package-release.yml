name: package-release

on:
  workflow_dispatch:
    inputs:
      version:
        description: Version string used in output filenames
        required: true
        type: string
  release:
    types:
      - published

permissions:
  contents: write

jobs:
  resolve-version:
    runs-on: ubuntu-latest
    outputs:
      version_raw: ${{ steps.version.outputs.version_raw }}
      version_safe: ${{ steps.version.outputs.version_safe }}
    steps:
      - name: Resolve version
        id: version
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            version_raw="${{ inputs.version }}"
          else
            version_raw="${{ github.event.release.tag_name }}"
          fi
          if [[ -z "${version_raw}" ]]; then
            echo "version is required" >&2
            exit 1
          fi

          version_safe="$(printf '%s' "${version_raw}" | sed -E 's/[^A-Za-z0-9._-]+/-/g')"
          if [[ -z "${version_safe}" ]]; then
            echo "sanitized version is empty" >&2
            exit 1
          fi

          echo "version_raw=${version_raw}" >> "${GITHUB_OUTPUT}"
          echo "version_safe=${version_safe}" >> "${GITHUB_OUTPUT}"

  build-console:
    runs-on: ${{ matrix.os }}
    needs: resolve-version
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            arch: x64
            goarch: amd64
          - os: ubuntu-24.04-arm
            arch: arm64
            goarch: arm64
    env:
      VERSION_RAW: ${{ needs.resolve-version.outputs.version_raw }}
      VERSION_SAFE: ${{ needs.resolve-version.outputs.version_safe }}
      GOARCH: ${{ matrix.goarch }}
      CONSOLE_BIN: onlyboxes-console_${{ needs.resolve-version.outputs.version_safe }}_linux_${{ matrix.goarch }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'release' && github.event.release.tag_name || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Enable Corepack
        run: corepack enable

      - name: Build web
        run: |
          set -euo pipefail
          yarn --cwd web install --immutable
          VITE_CONSOLE_VERSION="${VERSION_RAW}" yarn --cwd web build

      - name: Sync web dist into console embedded assets
        run: |
          set -euo pipefail
          rm -rf console/internal/httpapi/web_dist
          mkdir -p console/internal/httpapi/web_dist
          cp -R web/dist/. console/internal/httpapi/web_dist/

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.x"
          cache-dependency-path: console/go.sum

      - name: Build console binary
        run: |
          set -euo pipefail
          mkdir -p build
          (
            cd console
            CGO_ENABLED=0 GOOS=linux GOARCH="${GOARCH}" go build -trimpath \
              -ldflags "-X github.com/onlyboxes/onlyboxes/console/internal/buildinfo.Version=${VERSION_RAW}" \
              -o "../build/${CONSOLE_BIN}" \
              ./cmd/console
          )

      - name: Validate console binary architecture
        run: |
          set -euo pipefail
          console_info="$(file "build/${CONSOLE_BIN}")"
          echo "${console_info}"
          case "${GOARCH}" in
            amd64)
              grep -Eq "ELF 64-bit.*x86-64" <<< "${console_info}"
              ;;
            arm64)
              grep -Eq "ELF 64-bit.*ARM aarch64" <<< "${console_info}"
              ;;
            *)
              echo "unsupported GOARCH: ${GOARCH}" >&2
              exit 1
              ;;
          esac

      - name: Upload console workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: onlyboxes-console-linux-${{ matrix.arch }}-${{ env.VERSION_SAFE }}
          path: build/${{ env.CONSOLE_BIN }}
          if-no-files-found: error

      - name: Upload console release asset
        if: github.event_name == 'release'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          gh release upload "${VERSION_RAW}" "build/${CONSOLE_BIN}" --clobber

  build-worker:
    runs-on: ${{ matrix.os }}
    needs: resolve-version
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            arch: x64
            os_name: linux
            goos: linux
            goarch: amd64
          - os: ubuntu-24.04-arm
            arch: arm64
            os_name: linux
            goos: linux
            goarch: arm64
          - os: macos-15-intel
            arch: x64
            os_name: macos
            goos: darwin
            goarch: amd64
          - os: macos-15
            arch: arm64
            os_name: macos
            goos: darwin
            goarch: arm64
    env:
      VERSION_RAW: ${{ needs.resolve-version.outputs.version_raw }}
      VERSION_SAFE: ${{ needs.resolve-version.outputs.version_safe }}
      GOOS: ${{ matrix.goos }}
      GOARCH: ${{ matrix.goarch }}
      WORKER_BIN: onlyboxes-worker-docker_${{ needs.resolve-version.outputs.version_safe }}_${{ matrix.os_name }}_${{ matrix.goarch }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'release' && github.event.release.tag_name || github.ref }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.x"
          cache-dependency-path: worker/worker-docker/go.sum

      - name: Build worker binary
        run: |
          set -euo pipefail
          mkdir -p build
          (
            cd worker/worker-docker
            CGO_ENABLED=0 GOOS="${GOOS}" GOARCH="${GOARCH}" go build -trimpath \
              -ldflags "-X github.com/onlyboxes/onlyboxes/worker/worker-docker/internal/buildinfo.Version=${VERSION_RAW}" \
              -o "../../build/${WORKER_BIN}" \
              ./cmd/worker-docker
          )

      - name: Validate worker binary architecture
        run: |
          set -euo pipefail
          worker_info="$(file "build/${WORKER_BIN}")"
          echo "${worker_info}"
          case "${GOOS}/${GOARCH}" in
            linux/amd64)
              grep -Eq "ELF 64-bit.*x86-64" <<< "${worker_info}"
              ;;
            linux/arm64)
              grep -Eq "ELF 64-bit.*ARM aarch64" <<< "${worker_info}"
              ;;
            darwin/amd64)
              grep -Eq "Mach-O 64-bit executable x86_64" <<< "${worker_info}"
              ;;
            darwin/arm64)
              grep -Eq "Mach-O 64-bit executable arm64" <<< "${worker_info}"
              ;;
            *)
              echo "unsupported target: ${GOOS}/${GOARCH}" >&2
              exit 1
              ;;
          esac

      - name: Upload worker workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: onlyboxes-worker-docker-${{ matrix.os_name }}-${{ matrix.arch }}-${{ env.VERSION_SAFE }}
          path: build/${{ env.WORKER_BIN }}
          if-no-files-found: error

      - name: Upload worker release asset
        if: github.event_name == 'release'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          gh release upload "${VERSION_RAW}" "build/${WORKER_BIN}" --clobber

  docker-console:
    runs-on: ubuntu-latest
    needs:
      - resolve-version
      - build-console
    env:
      VERSION_SAFE: ${{ needs.resolve-version.outputs.version_safe }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'release' && github.event.release.tag_name || github.ref }}

      - name: Download console linux x64 binary artifact
        uses: actions/download-artifact@v4
        with:
          name: onlyboxes-console-linux-x64-${{ env.VERSION_SAFE }}
          path: build/console-linux-x64

      - name: Download console linux arm64 binary artifact
        uses: actions/download-artifact@v4
        with:
          name: onlyboxes-console-linux-arm64-${{ env.VERSION_SAFE }}
          path: build/console-linux-arm64

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Resolve Docker tags
        id: docker_tags
        env:
          VERSION_SAFE: ${{ needs.resolve-version.outputs.version_safe }}
        run: |
          set -euo pipefail
          image_repo="coolfan1024/onlyboxes"

          console_tags="${image_repo}:${VERSION_SAFE}"
          if [[ "${GITHUB_EVENT_NAME}" == "release" ]]; then
            console_tags+=$'\n'"${image_repo}:latest"
          fi

          {
            echo "console_tags<<EOF"
            echo "${console_tags}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      - name: Prepare Docker build context
        run: |
          set -euo pipefail
          mkdir -p build/docker/console
          cp "build/console-linux-x64/onlyboxes-console_${VERSION_SAFE}_linux_amd64" "build/docker/console/onlyboxes-console-amd64"
          cp "build/console-linux-arm64/onlyboxes-console_${VERSION_SAFE}_linux_arm64" "build/docker/console/onlyboxes-console-arm64"
          cp docker/console.dockerfile "build/docker/console/Dockerfile"

      - name: Build and push console image
        uses: docker/build-push-action@v6
        with:
          context: build/docker/console
          file: build/docker/console/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.docker_tags.outputs.console_tags }}
